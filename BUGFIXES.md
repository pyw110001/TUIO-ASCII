# Bug 修复说明

## 修复的问题

### 1. 单个触控点无法触发 ✅

**问题描述**：
- 需要同时使用两个触控点才能显示触控信号
- 单个触控点无法触发

**根本原因**：
- TUIO 协议中，`alive` 消息用于声明哪些 cursor 是活跃的
- 当 `alive` 消息为空（没有参数）时，原代码会清除所有 cursor
- 如果只发送一个 `set` 消息，然后发送空的 `alive` 消息，cursor 会被立即清除

**修复方案**：
- 修改 `alive` 消息处理逻辑：只有当 `alive` 列表明确包含其他 ID 时才清除不在列表中的 cursor
- 如果 `alive` 消息为空，不清除现有 cursor，让超时机制处理
- 这样单个 cursor 即使没有明确的 `alive` 消息，也能保持活跃直到超时

**代码位置**：`server/tuio-processor.js` - `handleOSCMessage()` 方法

### 2. 无法看到发送的帧 ✅

**问题描述**：
- 无法看到通过 TCP 发出的二进制帧
- 监控页面不显示发送的帧信息

**根本原因**：
- `sendFramesForZones()` 函数中，只有当 `tcpSender.send(frame)` 返回 `true` 时才会更新 `lastSentFrame`
- 如果 TCP 未连接，`send()` 返回 `false`，导致不会显示帧信息
- 这导致即使生成了协议帧，也无法在 UI 中查看

**修复方案**：
- 无论 TCP 是否连接，都记录要发送的帧信息
- 在 `lastSentFrame` 中添加 `tcpConnected` 和 `sent` 状态字段
- 在控制台输出帧信息（无论是否发送成功）
- 在 UI 中显示 TCP 连接状态和发送状态

**代码位置**：
- `server/index.js` - `sendFramesForZones()` 函数
- `client/src/pages/MonitorPage.jsx` - 监控页面显示

## 改进内容

### 1. 调试日志增强
- 添加 TUIO cursor 接收日志（显示 ID 和坐标）
- 添加 TCP 帧发送日志（显示十六进制帧）
- 区分已发送和未发送的帧

### 2. UI 显示改进
- 显示 TCP 连接状态
- 显示发送状态（已发送/未发送）
- 用不同颜色标识发送状态
- 即使 TCP 未连接也能查看生成的帧

### 3. 测试脚本优化
- 优化 `test-tuio-sender.js`，确保单个 cursor 能正确发送
- 改进消息发送时序

## 测试验证

### 测试单个触控点

1. **使用测试脚本**：
   ```bash
   node test-tuio-sender.js
   ```
   
2. **发送单个 cursor**：
   ```
   set 1 0.5 0.5
   ```

3. **预期结果**：
   - 监控页面应该显示 1 个 cursor
   - 区域状态应该更新（如果 cursor 落在区域内）
   - 应该能看到生成的协议帧

### 测试帧显示

1. **TCP 未连接时**：
   - 触发区域状态变化
   - 监控页面应该显示"最近发送的帧"
   - 帧信息应该显示"未发送（TCP未连接）"
   - 应该能看到完整的十六进制帧

2. **TCP 已连接时**：
   - 触发区域状态变化
   - 监控页面应该显示"最近发送的帧"
   - 帧信息应该显示"已发送"
   - 应该能看到完整的十六进制帧

## 使用建议

1. **调试 TUIO 输入**：
   - 查看控制台日志，确认收到 cursor 消息
   - 在监控页面查看 cursor 列表
   - 检查 cursor 坐标是否在 0-1 范围内

2. **调试协议帧**：
   - 即使 TCP 未连接，也能在监控页面查看生成的帧
   - 使用"测试发送"功能验证协议编码
   - 查看控制台日志确认帧的十六进制内容

3. **验证 TCP 发送**：
   - 确保 TCP 连接成功（监控页面显示"已连接"）
   - 触发区域状态变化
   - 在监控页面查看发送的帧
   - 使用网络抓包工具验证 TCP 数据

## 后续优化建议

1. **TUIO 消息处理**：
   - 支持更完整的 TUIO 协议（如 2Dobj）
   - 添加消息序列验证
   - 支持批量 cursor 更新

2. **帧显示**：
   - 添加发送历史记录
   - 支持帧的导出和保存
   - 添加帧的验证功能

3. **调试功能**：
   - 添加详细的调试模式开关
   - 支持日志级别控制
   - 添加性能监控

